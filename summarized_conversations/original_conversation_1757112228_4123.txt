{'role': 'assistant', 'content': '<function_calls>\n<create-file file_path="backend/src/utils/email.ts">\nimport nodemailer from \'nodemailer\';\nimport mjml2html from \'mjml\';\nimport { PrismaClient } from \'@prisma/client\';\nimport { logger } from \'./logger\';\n\nconst prisma = new PrismaClient();\n\n// Zoho Mail SMTP Configuration\nconst transporter = nodemailer.createTransporter({\n  host: \'smtp.zoho.com\',\n  port: 587,\n  secure: false, // true for 465, false for other ports\n  auth: {\n    user: process.env.ZOHO_EMAIL, // bluerockasset@zohomail.com\n    pass: process.env.ZOHO_APP_PASSWORD, // App-specific password\n  },\n});\n\nexport interface EmailTemplate {\n  subject: string;\n  mjml: string;\n  plainText: string;\n}\n\nexport interface EmailData {\n  to: string;\n  template: string;\n  data: Record<string, any>;\n}\n\nexport const emailTemplates: Record<string, EmailTemplate> = {\n  welcome: {\n    subject: \'Welcome to BlueRock Asset Management\',\n    mjml: `\n      <mjml>\n        <mj-head>\n          <mj-title>Welcome to BlueRock Asset Management</mj-title>\n          <mj-font name="Inter" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" />\n          <mj-attributes>\n            <mj-all font-family="Inter, Arial, sans-serif" />\n          </mj-attributes>\n        </mj-head>\n        <mj-body background-color="#f9fafb">\n          <mj-section background-color="#ffffff" padding="40px 20px">\n            <mj-column>\n              <mj-image src="{{logoUrl}}" alt="BlueRock Asset Management" width="200px" />\n              <mj-text font-size="24px" font-weight="600" color="#0066CC" align="center" padding="20px 0">\n                Welcome to BlueRock Asset Management\n              </mj-text>\n              <mj-text font-size="16px" color="#374151" line-height="1.6">\n                Dear {{firstName}},\n              </mj-text>\n              <mj-text font-size="16px" color="#374151" line-height="1.6">\n                Welcome to BlueRock Asset Management, where your financial future meets expert guidance and innovative investment solutions.\n              </mj-text>\n              <mj-text font-size="16px" color="#374151" line-height="1.6">\n                Your account has been successfully created. You can now access your dashboard to:\n              </mj-text>\n              <mj-text font-size="14px" color="#374151" line-height="1.8" padding-left="20px">\n                • Make secure cryptocurrency deposits<br/>\n                • Track your investment performance<br/>\n                • Monitor weekly payouts<br/>\n                • Access detailed transaction history<br/>\n                • Manage withdrawal requests\n              </mj-text>\n              <mj-button background-color="#0066CC" color="#ffffff" font-size="16px" font-weight="600" href="{{dashboardUrl}}" padding="20px 0">\n                Access Your Dashboard\n              </mj-button>\n              <mj-text font-size="14px" color="#6B7280" line-height="1.6" padding="20px 0 0 0">\n                If you have any questions, our support team is available 24/7 through live chat or email.\n              </mj-text>\n            </mj-column>\n          </mj-section>\n          <mj-section background-color="#f9fafb" padding="20px">\n            <mj-column>\n              <mj-text font-size="12px" color="#9CA3AF" align="center">\n                © 2025 BlueRock Asset Management. All rights reserved.<br/>\n                This email was sent to {{email}}. Investment involves risk.\n              </mj-text>\n            </mj-column>\n          </mj-section>\n        </mj-body>\n      </mjml>\n    `,\n    plainText: `Welcome to BlueRock Asset Management\n\nDear {{firstName}},\n\nWelcome to BlueRock Asset Management, where your financial future meets expert guidance and innovative investment solutions.\n\nYour account has been successfully created. You can now access your dashboard to:\n• Make secure cryptocurrency deposits\n• Track your investment performance  \n• Monitor weekly payouts\n• Access detailed transaction history\n• Manage withdrawal requests\n\nAccess your dashboard: {{dashboardUrl}}\n\nIf you have any questions, our support team is available 24/7 through live chat or email.\n\n© 2025 BlueRock Asset Management. All rights reserved.\nThis email was sent to {{email}}. Investment involves risk.`\n  },\n\n  depositReceived: {\n    subject: \'Deposit Received - Pending Confirmation\',\n    mjml: `\n      <mjml>\n        <mj-head>\n          <mj-title>Deposit Received</mj-title>\n          <mj-font name="Inter" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" />\n        </mj-head>\n        <mj-body background-color="#f9fafb">\n          <mj-section background-color="#ffffff" padding="40px 20px">\n            <mj-column>\n              <mj-image src="{{logoUrl}}" alt="BlueRock Asset Management" width="200px" />\n              <mj-text font-size="24px" font-weight="600" color="#0066CC" align="center">\n                Deposit Received\n              </mj-text>\n              <mj-text font-size="16px" color="#374151">\n                Dear {{firstName}},\n              </mj-text>\n              <mj-text font-size="16px" color="#374151">\n                We have received your deposit submission and it is currently being processed.\n              </mj-text>\n              <mj-table>\n                <tr style="border-bottom:1px solid #E5E7EB;text-align:left;">\n                  <td style="padding: 10px; font-weight: 600;">Amount:</td>\n                  <td style="padding: 10px;">${{amount}} USD</td>\n                </tr>\n                <tr style="border-bottom:1px solid #E5E7EB;text-align:left;">\n                  <td style="padding: 10px; font-weight: 600;">Cryptocurrency:</td>\n                  <td style="padding: 10px;">{{cryptoType}}</td>\n                </tr>\n                <tr style="border-bottom:1px solid #E5E7EB;text-align:left;">\n                  <td style="padding: 10px; font-weight: 600;">Transaction ID:</td>\n                  <td style="padding: 10px;">{{transactionId}}</td>\n                </tr>\n                <tr style="text-align:left;">\n                  <td style="padding: 10px; font-weight: 600;">Status:</td>\n                  <td style="padding: 10px; color: #F59E0B;">Pending Confirmation</td>\n                </tr>\n              </mj-table>\n              <mj-text font-size="14px" color="#6B7280">\n                Your deposit will be confirmed within 24 hours. Once confirmed, your investment plan will automatically begin.\n              </mj-text>\n            </mj-column>\n          </mj-section>\n        </mj-body>\n      </mjml>\n    `,\n    plainText: `Deposit Received - Pending Confirmation\n\nDear {{firstName}},\n\nWe have received your deposit submission and it is currently being processed.\n\nAmount: ${{amount}} USD\nCryptocurrency: {{cryptoType}}\nTransaction ID: {{transactionId}}\nStatus: Pending Confirmation\n\nYour deposit will be confirmed within 24 hours. Once confirmed, your investment plan will automatically begin.`\n  },\n\n  depositConfirmed: {\n    subject: \'Investment Plan Activated - Welcome to BlueRock\',\n    mjml: `\n      <mjml>\n        <mj-head>\n          <mj-title>Investment Plan Activated</mj-title>\n          <mj-font name="Inter" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" />\n        </mj-head>\n        <mj-body background-color="#f9fafb">\n          <mj-section background-color="#ffffff" padding="40px 20px">\n            <mj-column>\n              <mj-image src="{{logoUrl}}" alt="BlueRock Asset Management" width="200px" />\n              <mj-text font-size="24px" font-weight="600" color="#10B981" align="center">\n                Investment Plan Activated\n              </mj-text>\n              <mj-text font-size="16px" color="#374151">\n                Congratulations {{firstName}}!\n              </mj-text>\n              <mj-text font-size="16px" color="#374151">\n                Your deposit has been confirmed and your investment plan is now active.\n              </mj-text>\n              <mj-table>\n                <tr style="border-bottom:1px solid #E5E7EB;text-align:left;">\n                  <td style="padding: 10px; font-weight: 600;">Investment Amount:</td>\n                  <td style="padding: 10px;">${{amount}} USD</td>\n                </tr>\n                <tr style="border-bottom:1px solid #E5E7EB;text-align:left;">\n                  <td style="padding: 10px; font-weight: 600;">Weekly Payout:</td>\n                  <td style="padding: 10px;">${{weeklyPayout}} USD</td>\n                </tr>\n                <tr style="border-bottom:1px solid #E5E7EB;text-align:left;">\n                  <td style="padding: 10px; font-weight: 600;">Plan Duration:</td>\n                  <td style="padding: 10px;">8 weeks</td>\n                </tr>\n                <tr style="border-bottom:1px solid #E5E7EB;text-align:left;">\n                  <td style="padding: 10px; font-weight: 600;">First Payout:</td>\n                  <td style="padding: 10px;">{{nextPayoutDate}}</td>\n                </tr>\n                <tr style="text-align:left;">\n                  <td style="padding: 10px; font-weight: 600;">Total Returns:</td>\n                  <td style="padding: 10px; color: #10B981; font-weight: 600;">${{totalReturns}} USD</td>\n                </tr>\n              </mj-table>\n              <mj-button background-color="#0066CC" color="#ffffff" href="{{dashboardUrl}}">\n                View Investment Dashboard\n              </mj-button>\n            </mj-column>\n          </mj-section>\n        </mj-body>\n      </mjml>\n    `,\n    plainText: `Investment Plan Activated\n\nCongratulations {{firstName}}!\n\nYour deposit has been confirmed and your investment plan is now active.\n\nInvestment Amount: ${{amount}} USD\nWeekly Payout: ${{weeklyPayout}} USD\nPlan Duration: 8 weeks\nFirst Payout: {{nextPayoutDate}}\nTotal Returns: ${{totalReturns}} USD\n\nView your dashboard: {{dashboardUrl}}`\n  },\n\n  weeklyPayout: {\n    subject: \'Weekly Payout Sent - ${{amount}}\',\n    mjml: `\n      <mjml>\n        <mj-head>\n          <mj-title>Weekly Payout Sent</mj-title>\n          <mj-font name="Inter" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" />\n        </mj-head>\n        <mj-body background-color="#f9fafb">\n          <mj-section background-color="#ffffff" padding="40px 20px">\n            <mj-column>\n              <mj-image src="{{logoUrl}}" alt="BlueRock Asset Management" width="200px" />\n              <mj-text font-size="24px" font-weight="600" color="#10B981" align="center">\n                Weekly Payout Sent\n              </mj-text>\n              <mj-text font-size="16px" color="#374151">\n                Dear {{firstName}},\n              </mj-text>\n              <mj-text font-size="16px" color="#374151">\n                Your weekly payout has been successfully processed and sent to your account.\n              </mj-text>\n              <mj-table>\n                <tr style="border-bottom:1px solid #E5E7EB;text-align:left;">\n                  <td style="padding: 10px; font-weight: 600;">Payout Amount:</td>\n                  <td style="padding: 10px; color: #10B981; font-weight: 600;">${{amount}} USD</td>\n                </tr>\n                <tr style="border-bottom:1px solid #E5E7EB;text-align:left;">\n                  <td style="padding: 10px; font-weight: 600;">Week Number:</td>\n                  <td style="padding: 10px;">{{weekNumber}} of 8</td>\n                </tr>\n                <tr style="border-bottom:1px solid #E5E7EB;text-align:left;">\n                  <td style="padding: 10px; font-weight: 600;">Date:</td>\n                  <td style="padding: 10px;">{{payoutDate}}</td>\n                </tr>\n                <tr style="text-align:left;">\n                  <td style="padding: 10px; font-weight: 600;">Next Payout:</td>\n                  <td style="padding: 10px;">{{nextPayoutDate}}</td>\n                </tr>\n              </mj-table>\n              <mj-button background-color="#0066CC" color="#ffffff" href="{{dashboardUrl}}">\n                View Transaction History\n              </mj-button>\n            </mj-column>\n          </mj-section>\n        </mj-body>\n      </mjml>\n    `,\n    plainText: `Weekly Payout Sent - ${{amount}}\n\nDear {{firstName}},\n\nYour weekly payout has been successfully processed and sent to your account.\n\nPayout Amount: ${{amount}} USD\nWeek Number: {{weekNumber}} of 8\nDate: {{payoutDate}}\nNext Payout: {{nextPayoutDate}}\n\nView your transaction history: {{dashboardUrl}}`\n  }\n};\n\nexport const sendEmail = async (emailData: EmailData): Promise<boolean> => {\n  try {\n    const template = emailTemplates[emailData.template];\n    if (!template) {\n      throw new Error(`Email template \'${emailData.template}\' not found`);\n    }\n\n    // Replace template variables\n    let mjmlContent = template.mjml;\n    let plainTextContent = template.plainText;\n    let subject = template.subject;\n\n    Object.entries(emailData.data).forEach(([key, value]) => {\n      const placeholder = `{{${key}}}`;\n      mjmlContent = mjmlContent.replace(new RegExp(placeholder, \'g\'), String(value));\n      plainTextContent = plainTextContent.replace(new RegExp(placeholder, \'g\'), String(value));\n      subject = subject.replace(new RegExp(placeholder, \'g\'), String(value));\n    });\n\n    // Convert MJML to HTML\n    const { html } = mjml2html(mjmlContent);\n\n    // Log email attempt\n    const emailLog = await prisma.emailLog.create({\n      data: {\n        to: emailData.to,\n        subject,\n        template: emailData.template,\n        status: \'PENDING\',\n      },\n    });\n\n    // Send email\n    await transporter.sendMail({\n      from: `"BlueRock Asset Management" <${process.env.ZOHO_EMAIL}>`,\n      to: emailData.to,\n      subject,\n      html,\n      text: plainTextContent,\n    });\n\n    // Update email log\n    await prisma.emailLog.update({\n      where: { id: emailLog.id },\n      data: {\n        status: \'SENT\',\n        sentAt: new Date(),\n      },\n    });\n\n    logger.info(`Email sent successfully to ${emailData.to}`);\n    return true;\n\n  } catch (error) {\n    logger.error(\'Failed to send email:\', error);\n    \n    // Update email log with error\n    try {\n      await prisma.emailLog.updateMany({\n        where: {\n          to: emailData.to,\n          template: emailData.template,\n          status: \'PENDING\',\n        },\n        data: {\n          status: \'FAILED\',\n          error: error instanceof Error ? error.message : \'Unknown error\',\n        },\n      });\n    } catch (logError) {\n      logger.error(\'Failed to update email log:\', logError);\n    }\n\n    return false;\n  }\n};\n\n// Test email configuration\nexport const testEmailConnection = async (): Promise<boolean> => {\n  try {\n    await transporter.verify();\n    logger.info(\'Email configuration verified successfully\');\n    return true;\n  } catch (error) {\n    logger.error(\'Email configuration test failed:\', error);\n    return false;\n  }\n};\n</create-file>\n</function_calls>'}